version: '3.8'

services:
  mqtt-proxy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mqtt-proxy
    restart: unless-stopped
    ports:
      - "3999:3000"  # Web API port (MQTT now handled by mosquitto)
    volumes:
      - mqtt-proxy-data:/app/data  # Persistent storage for broker configs
    environment:
      - LOG_LEVEL=info
      - RUST_LOG=mqtt_proxy=info,rumqttc=warn
      - MAIN_BROKER_ADDRESS=mosquitto:1883
      - MQTT_PROXY_SECRET=CHANGE-ME-DEV  # Change this in production!
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      mqtt-network:
      host-network:
    depends_on:
      - mosquitto
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 128M

  # Web UI is now integrated into the mqtt-proxy container
  # Served directly at http://localhost:3999/
  #
  # web-ui:
  #   build:
  #     context: ./web-ui
  #     dockerfile: Dockerfile
  #   container_name: mqtt-proxy-ui
  #   restart: unless-stopped
  #   ports:
  #     - "8080:80"
  #   environment:
  #     - VITE_API_URL=http://localhost:3000
  #   networks:
  #     - mqtt-network
  #   depends_on:
  #     - mqtt-proxy

  # Main MQTT broker (Eclipse Mosquitto)
  # Clients and MQTT Explorer connect here
  mosquitto:
    build:
      context: .
      dockerfile: Dockerfile.mosquitto
    container_name: mqtt-main-broker
    restart: unless-stopped
    ports:
      - "1883:1883"  # Main MQTT port - clients connect here
    networks:
      - mqtt-network

networks:
  mqtt-network:
    driver: bridge
  host-network:
    driver: bridge

volumes:
  mqtt-proxy-data:
    driver: local
